<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arkiv Ticket Management - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .admin-nav {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        
        .admin-nav a:hover,
        .admin-nav a.active {
            background: rgba(255,255,255,0.3);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .dashboard-card h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #636e72;
            font-size: 0.9rem;
        }
        
        .admin-actions {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .admin-actions h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .seat-overview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .mini-seat-map {
            display: grid;
            gap: 2px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .mini-seat-row {
            display: flex;
            gap: 2px;
        }
        
        .mini-seat {
            width: 8px;
            height: 8px;
            border-radius: 1px;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container">
            <h1 style="text-align: center;">
                <i class="fas fa-cogs"></i> Ticket Management Admin
            </h1>
            <nav class="admin-nav">
                <a href="#dashboard" class="active"><i class="fas fa-chart-pie"></i> Dashboard</a>
                <a href="#sales"><i class="fas fa-shopping-cart"></i> Sales</a>
                <a href="#customers"><i class="fas fa-users"></i> Customers</a>
                <a href="../index.html"><i class="fas fa-eye"></i> View Public Site</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Stats -->
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3><i class="fas fa-ticket-alt"></i> Total Sales</h3>
                <div class="stat-number" id="total-sales">0</div>
                <div class="stat-label">tickets sold</div>
            </div>
            
            <div class="dashboard-card">
                <h3><i class="fas fa-dollar-sign"></i> Revenue</h3>
                <div class="stat-number" id="total-revenue">$0</div>
                <div class="stat-label">total earnings</div>
            </div>
            
            <div class="dashboard-card">
                <h3><i class="fas fa-chair"></i> Availability</h3>
                <div class="stat-number" id="available-seats">0</div>
                <div class="stat-label">seats available</div>
            </div>
            
            <div class="dashboard-card">
                <h3><i class="fas fa-percentage"></i> Occupancy</h3>
                <div class="stat-number" id="occupancy-rate">0%</div>
                <div class="stat-label">venue occupied</div>
            </div>
        </div>

        <!-- Admin Actions -->
        <div class="admin-actions">
            <h3><i class="fas fa-tools"></i> Quick Actions</h3>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="initializeEvent()">
                    <i class="fas fa-play"></i> Initialize Event
                </button>
                <button class="btn btn-secondary" onclick="refreshStats()">
                    <i class="fas fa-sync"></i> Refresh Data
                </button>
                <button class="btn btn-secondary" onclick="exportSales()">
                    <i class="fas fa-download"></i> Export Sales
                </button>
                <button class="btn btn-secondary" onclick="viewBlockchainData()">
                    <i class="fas fa-cube"></i> View Blockchain Data
                </button>
            </div>
        </div>

        <!-- Seat Overview -->
        <div class="seat-overview">
            <h3><i class="fas fa-th"></i> Seat Map Overview</h3>
            <p>Real-time seat availability visualization</p>
            <div id="mini-seat-map" class="mini-seat-map">
                <div style="text-align: center; padding: 20px; color: #636e72;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading seat map...</p>
                </div>
            </div>
        </div>

        <!-- Event Details -->
        <div class="dashboard-card" style="margin-top: 30px;">
            <h3><i class="fas fa-info-circle"></i> Event Information</h3>
            <div id="event-details">
                <p>Loading event details...</p>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:3001';
        
        // Load admin dashboard data
        async function loadDashboardData() {
            try {
                // Load event data
                const eventResponse = await fetch(`${API_BASE_URL}/api/event`);
                const eventData = await eventResponse.json();
                
                if (eventData.success) {
                    displayEventDetails(eventData.event);
                }
                
                // Load seat data
                const seatsResponse = await fetch(`${API_BASE_URL}/api/seats`);
                const seatsData = await seatsResponse.json();
                
                if (seatsData.success) {
                    updateDashboardStats(seatsData.seats);
                    createMiniSeatMap(seatsData.seats);
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }
        
        // Display event details
        function displayEventDetails(event) {
            const detailsElement = document.getElementById('event-details');
            const date = new Date(event.date);
            
            detailsElement.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <strong>Event:</strong><br>
                        ${event.name}
                    </div>
                    <div>
                        <strong>Venue:</strong><br>
                        ${event.venue}
                    </div>
                    <div>
                        <strong>Date:</strong><br>
                        ${date.toLocaleDateString()}
                    </div>
                    <div>
                        <strong>Time:</strong><br>
                        ${event.time}
                    </div>
                    <div>
                        <strong>Total Seats:</strong><br>
                        ${event.totalRows * event.seatsPerRow}
                    </div>
                    <div>
                        <strong>Layout:</strong><br>
                        ${event.totalRows} rows Ã— ${event.seatsPerRow} seats
                    </div>
                </div>
            `;
        }
        
        // Update dashboard statistics
        function updateDashboardStats(seats) {
            const stats = calculateStats(seats);
            
            document.getElementById('total-sales').textContent = stats.sold;
            document.getElementById('total-revenue').textContent = `$${stats.revenue.toLocaleString()}`;
            document.getElementById('available-seats').textContent = stats.available;
            document.getElementById('occupancy-rate').textContent = `${stats.occupancyRate}%`;
        }
        
        // Calculate seat statistics
        function calculateStats(seats) {
            const total = seats.length;
            let available = 0;
            let sold = 0;
            let reserved = 0;
            let revenue = 0;
            
            seats.forEach(seat => {
                switch (seat.status) {
                    case 'available':
                        available++;
                        break;
                    case 'sold':
                        sold++;
                        revenue += seat.price;
                        break;
                    case 'reserved':
                        reserved++;
                        break;
                }
            });
            
            const occupancyRate = Math.round(((sold + reserved) / total) * 100);
            
            return {
                total,
                available,
                sold,
                reserved,
                revenue,
                occupancyRate
            };
        }
        
        // Create mini seat map
        function createMiniSeatMap(seats) {
            const mapElement = document.getElementById('mini-seat-map');
            
            // Group seats by row
            const seatsByRow = seats.reduce((groups, seat) => {
                const row = seat.row;
                if (!groups[row]) groups[row] = [];
                groups[row].push(seat);
                return groups;
            }, {});
            
            const totalRows = Math.max(...Object.keys(seatsByRow).map(Number));
            
            mapElement.innerHTML = '';
            mapElement.style.gridTemplateRows = `repeat(${totalRows}, 8px)`;
            
            for (let rowNumber = 1; rowNumber <= totalRows; rowNumber++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'mini-seat-row';
                
                const rowSeats = seatsByRow[rowNumber] || [];
                rowSeats.sort((a, b) => a.column - b.column);
                
                rowSeats.forEach(seat => {
                    const seatDiv = document.createElement('div');
                    seatDiv.className = 'mini-seat';
                    
                    switch (seat.status) {
                        case 'available':
                            seatDiv.style.backgroundColor = '#51cf66';
                            break;
                        case 'selected':
                            seatDiv.style.backgroundColor = '#667eea';
                            break;
                        case 'reserved':
                            seatDiv.style.backgroundColor = '#fd7e14';
                            break;
                        case 'sold':
                            seatDiv.style.backgroundColor = '#e64980';
                            break;
                    }
                    
                    rowDiv.appendChild(seatDiv);
                });
                
                mapElement.appendChild(rowDiv);
            }
        }
        
        // Admin action functions
        async function initializeEvent() {
            if (!confirm('This will initialize the event seating on the Arkiv blockchain. Continue?')) {
                return;
            }
            
            try {
                showLoading(true);
                
                // Call backend initialization endpoint
                const response = await fetch(`${API_BASE_URL}/api/admin/initialize`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Event initialized successfully!');
                    await refreshStats();
                } else {
                    throw new Error('Failed to initialize event');
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize event: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function refreshStats() {
            await loadDashboardData();
            alert('Dashboard data refreshed!');
        }
        
        function exportSales() {
            // Placeholder for sales export functionality
            alert('Sales export feature coming soon!');
        }
        
        function viewBlockchainData() {
            // Placeholder for blockchain explorer integration
            alert('Blockchain data viewer coming soon!');
        }
        
        function showError(message) {
            alert('Error: ' + message);
        }
        
        function showLoading(show) {
            // Simple loading implementation
            const body = document.body;
            if (show) {
                body.style.cursor = 'wait';
            } else {
                body.style.cursor = 'default';
            }
        }
        
        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            
            // Refresh data every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>